---
- name: Install Netplan
  ansible.builtin.apt:
    name:
      - netplan.io
    state: present
    force_apt_get: yes
    update_cache: yes

- name: Set Netplan configuration
  ansible.builtin.copy:
    src: "{{ netplan_config }}"
    dest: /etc/netplan/config.yaml
    mode: u=rw,g=r,o=r
  notify:
    - Apply Netplan configuration

- name: Remove configuration generated by installer
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    # Taken from Subiquity sources:
    # https://github.com/canonical/subiquity/blob/d4f76d1ce8636c9843b74ce99163c714db9b027f/subiquity/models/network.py#L35
    - /etc/netplan/00-installer-config.yaml
    - /etc/netplan/00-installer-config-wifi.yaml
    - /etc/cloud/cloud.cfg.d/subiquity-disable-cloudinit-networking.cfg
  notify:
    - Apply Netplan configuration
  when: netplan_installer_disable

- name: Disable Cloud-init network configuration
  ansible.builtin.copy:
    src: 99-disable-network-config.cfg
    dest: /etc/cloud/cloud.cfg.d/
    mode: u=rw,g=r,o=r
  when: netplan_cloudinit_disable

- name: Remove Netplan configuration generated by Cloud-init
  ansible.builtin.file:
    path: /etc/netplan/50-cloud-init.yaml
    state: absent
  when: netplan_cloudinit_disable

- name: Disable ifupdown
  ansible.builtin.systemd:
    name: networking.service
    enabled: no
  when: netplan_ifupdown_disable

- name: Reset /etc/network/interfaces
  ansible.builtin.copy:
    src: interfaces
    dest: /etc/network/interfaces
    mode: u=rw,g=r,o=r
    backup: yes
  when: netplan_ifupdown_reset_interfaces

- name: Enable systemd-networkd
  ansible.builtin.systemd:
    name: systemd-networkd.service
    state: started
    enabled: yes
  when: netplan_networkd_enable

- name: Enable systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved.service
    state: started
    enabled: yes
  when: netplan_resolved_enable

- name: Symlink systemd-resolved stub from /etc/resolv.conf
  ansible.builtin.file:
    path: /etc/resolv.conf
    state: link
    src: /run/systemd/resolve/stub-resolv.conf
    force: yes
  when: netplan_resolved_enable
